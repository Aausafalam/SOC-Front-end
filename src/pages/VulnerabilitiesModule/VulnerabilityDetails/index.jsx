import React, { useEffect, useState } from 'react'
import styles from "./index.module.css"
import DynamicForm from '../../../components/Form/DynamicForm';
import { ICON } from '../../../utils/icon';
import axios from 'axios';
import Utils from '../../../utils';

const VulnerabilityDetails = ({id,onCancel,onSuccess}) => {
   
   
    const assignees = [{label:"Rishik", value:"rishik"}, {label:"Amit Negi", value:"Amit Negi"}, {label:"himanshu", value:"himanshu"}]
    // const renderJson = (json) => {
    //     const formatJson = (obj) => {
    //       return Object.entries(obj).map(([key, value]) => {
    //         const isObject = value && typeof value === 'object';
    //         return (
    //           <div key={key} style={{ marginBottom: '10px' }}>
    //             <span style={{ color: '#ff9800', fontWeight: 'bold' }}>{key}: </span>
    //             {isObject ? (
    //               <div style={{ paddingLeft: '20px' }}>
    //                 {formatJson(value)}
    //               </div>
    //             ) : (
    //               <span style={{ color: '#4caf50' }}>{JSON.stringify(value)}</span>
    //             )}
    //           </div>
    //         );
    //       });
    //     };
    
    //     return formatJson(json);
    //   };

      const handleSubmit = async (formData) => {
        if (formData) {
         //console.log(formData)
         axios.post('http://192.168.40.52:5000/api/create_ticket', { id, ...formData })
         .then(response => {
            onSuccess(response.data.status);
        //    setDetailModalIsOpen(false);
        //    fetchData(); // Refresh the data
         })
         .catch(error => {
           console.error('Error creating ticket:', error)
           alert("Failed to create ticket. Please try again")
         });
        } else {
            //add
        }
         
      };
    
      const buttons = [
        {
          label: "Submit",
          className: "btn-green",
          type: "Submit",
          icon: ICON.CHECK_MARK,
        },
        {
          label: "Cancel",
          className: "btn-red",
          onClick: onCancel,
          icon: ICON.CANCEL,
        },
      ];

      const [data,setData] = useState({
        assignTo:"",
        intel:""
      })
      const formData = [
        {
          type: "text",
          name: "intel",
          label: "Intel",
          required: true,
          grid:2,
          defaultValue: data?.intel,
        },
        {
            type: "select",
            name: "assignTo",
            label: "Assign To",
            grid: 2,
            required: true,
            options: assignees,
            defaultValue: data?.assignTo,
        },
      ];
    
     
       const [detailsData,setDetailsData] = useState({})

       const fetchDetailedData = (id) => {
        axios.get(`http://192.168.40.52:5000/api/detail/${id}`)
          .then(response => {
            setDetailsData(response.data) ;
          })
          .catch(error => console.error('Error fetching detailed data:', error));
      };

     useEffect(() => {
        fetchDetailedData(id)
     },[id])

  return (<div className={styles.container}>
      <div>
         <h2>Details for {detailsData.vulnerability_id}</h2>
         {Utils.renderJson(detailsData)}
      </div>
      <div>
        <h2>Create Ticket</h2>
         <DynamicForm
        formData={formData}
        formButtons={buttons}
        onSubmit={handleSubmit}
      />
      </div>
  </div>
  )
}

export default VulnerabilityDetails