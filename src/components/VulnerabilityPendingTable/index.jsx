import React, { useEffect, useState } from 'react'
import styles from "./index.module.css"
import Utils from "../../utils";
import { useAssets } from '../../context/AssetsContext';
import Table from '../Table/Table';
import { useVulnerability } from '../../context/VulnerabilityContext';
import Popup from '../Popup/Popup';
import VulnerabilityDetails from '../../pages/VulnerabilitiesModule/VulnerabilityDetails';
import {  toast } from 'react-toastify';;
const VulnerabilityTable = () => { 


    const [showPopup, setShowPopup] = useState(false);
    const {vulnerabilityList, fetchVulnerabilityList} = useVulnerability();
    const [vulerabilityData,setVulnerabilityData] = useState({
      "data": [
        {
          "affected_package": "shim-signed",
          "asset_id": "lcg1101",
          "base_score": "6.2",
          "cve": "CVE-2023-40548",
          "id": "21533858ff113e5993973a9cae6d0668f54e77700b6584b8a5b5a530406d4a78",
          "severity": "Medium"
        },
        {
          "affected_package": "shim-signed",
          "asset_id": "lcg1101",
          "base_score": "5.5",
          "cve": "CVE-2023-40549",
          "id": "5ca1c108ad82242b91b140f9ef78d7b36eaf8691ef24ee187525c1210c7ac107",
          "severity": "Medium"
        },
        {
          "affected_package": "shim-signed",
          "asset_id": "lcg1101",
          "base_score": "5.5",
          "cve": "CVE-2023-40550",
          "id": "d23cccc9cd6ecc265538ca2736dec17bcea1081fc2b345c31a5e5b3b8105bd63",
          "severity": "Medium"
        },
        {
          "affected_package": "dmidecode",
          "asset_id": "lcg1101",
          "base_score": "7.1",
          "cve": "CVE-2023-30630",
          "id": "19b142ab86154921c697e473d96cb757adb96781783d54531b3c30b5ef699c04",
          "severity": "High"
        },
        {
          "affected_package": "libsmbclient",
          "asset_id": "lcg1101",
          "base_score": "5.9",
          "cve": "CVE-2021-20251",
          "id": "31cb3971c2b6a2d4d07934538784079bdd4ccae775a65e8030a96eefbd826e03",
          "severity": "Medium"
        },
        {
          "affected_package": "paramiko",
          "asset_id": "lcg1101",
          "base_score": "5.9",
          "cve": "CVE-2023-48795",
          "id": "6bb13fbcc51767a6b86e41e39a5fe39f5580d404d1a118e940d714ee528d4659",
          "severity": "Medium"
        },
        {
          "affected_package": "network-manager",
          "asset_id": "lcg1101",
          "base_score": "4.9",
          "cve": "CVE-2012-1096",
          "id": "621641e74c34b7c3bab289850c3b2fe969c57f81e0edcc2d3275554cf81c5c87",
          "severity": "Medium"
        },
        {
          "affected_package": "libxml-twig-perl",
          "asset_id": "lcg1101",
          "base_score": "6.4",
          "cve": "CVE-2016-9180",
          "id": "5e89c549d1e6e506c58e3cbb41a7f4ef76404ce781c0827da961dd66f908453c",
          "severity": "Medium"
        },
        {
          "affected_package": "urllib3",
          "asset_id": "lcg1101",
          "base_score": "4.2",
          "cve": "CVE-2023-45803",
          "id": "0a8668672c4ae027626f76f0eb3ff08ec9ec4da98442664437bb8888b0c1aa0c",
          "severity": "Medium"
        },
        {
          "affected_package": "urllib3",
          "asset_id": "lcg1101",
          "base_score": "5.9",
          "cve": "CVE-2023-43804",
          "id": "027a3cf60e252a0b52b4dae190f1abc190c8d01bb6e8901324867303227477f5",
          "severity": "Medium"
        }
      ],
      "page": 1,
      "per_page": 10,
      "total": 2780,
      "total_pages": 278
    }
    )

    const [id,setId] = useState(null)
    const togglePopup = () => setShowPopup(prev => !prev);
    const onSuccess = (data) => {
      toast(data)
      setShowPopup(false)
      fetchVulnerabilityList()
    }
    useEffect(()=>{
          fetchVulnerabilityList();
    },[]);
    //console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>",vulnerabilityList)
    function getTableData(data) {

        //console.log(data)
        return {
          ...Utils.GetTableData(),
          title: "Vulnerability Pending List",
          rows: data?.data?.map((item, index) => {
            const row = {
              Id: { key: "id", value: item.id, type: "hidden" },
              "S.No.": {
                key: "S.No.",
                value: index + 1,
                removeFromAutoSuggestion: true,
              },
              "Severity": {
                key: "severity",
                value: item.severity,
              },
              "Base Score": {
                key: "assetTypeName",
                value: item.base_score,
              },
              "CVE": {
                key: "cve",
                value: item.cve,
              },
              "Asset ID": {
                key: "asset_id",
                value: item.asset_id,
              },
              "Affected Package": {
                key: "affected_package",
                value: item.affected_package || "No",
              }

            };
            return row;
          }),
          actionData: [
            {
              name: "Inspect",
              functions: (index) => {
               //console.log(index)
               setId(index)
               setShowPopup(true)
              },
              label: "Inspect",
              Id: "Id",
            },
          ],
           action: true,
           export:false,
           print:false,
          searchUrl: "/assetsTable.json",
          exportDataUrl: false,
          printUrl: false,
          paginationUrl: "http://192.168.40.52:5000/api/data?page=input&limit=count",
          totalPage: data?.total_pages,
          totalItemCount: data?.total,
          // autoSuggestionUrl: "/assetsTable.json",
          initialSort: "Severity",
          getTableData: getTableData,
        };
      }

  

      const tableData = React.useMemo(() => getTableData(vulerabilityData), [vulerabilityData]);

  return ( <div className={styles.container}>
 <Table tableData={tableData} />
 <Popup width="70%" show={showPopup} onClose={togglePopup} title={`Details`}>
        <VulnerabilityDetails id={id} onCancel={togglePopup} onSuccess={onSuccess}/>
      </Popup>
  </div>
  )
}

export default VulnerabilityTable